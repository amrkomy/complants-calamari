<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>إدارة الشكاوى | كليماري</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- OneSignal Web SDK - App ID للإدارة -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "fb14d9b6-5b07-47c7-bc70-ff2495372d38" // ← App ID خاص بالإدارة
      });
    });
  </script>
  <style>
    /* Modal إرسال الإشعارات */
    #broadcastModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #broadcastModal .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
    }
    #broadcastModal input,
    #broadcastModal textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: 'Tajawal', sans-serif;
      font-size: 14px;
    }
    #broadcastModal button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      font-family: 'Tajawal', sans-serif;
      cursor: pointer;
      font-size: 14px;
    }
    #confirmBroadcast { background: #000; color: white; }
    #cancelBroadcast { background: #ddd; color: #333; }

    /* باقي الأنماط (من الكود الأصلي) */
    .install-pwa-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #000;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }
    .install-pwa-btn:hover { transform: scale(1.1); background: #333; }
    .install-pwa-btn i { font-size: 24px; }
    .install-pwa-btn.hidden { display: none; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @media (max-width: 768px) {
      .install-pwa-btn { bottom: 70px; left: 15px; width: 50px; height: 50px; }
    }

    .comments-section, .add-comment-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
    .comments-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
    .comment-item { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; border-left: 3px solid #000; }
    .comment-author { font-weight: bold; color: #000; }
    .comment-date { font-size: 12px; color: #777; margin-top: 4px; }
    .add-comment-section textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; resize: vertical; min-height: 60px; }
    .comment-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-family: 'Tajawal', sans-serif; }
    .comment-btn:hover { background: #218838; }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="top-bar">
      <h2 class="page-title">إدارة الشكاوى</h2>
      <div class="top-bar-actions">
        <!-- ✅ زر داخلي لإرسال إشعارات للعملاء -->
        <button id="sendBroadcastBtn" class="stats-btn">
          <i class="fas fa-bell"></i> إرسال إشعار للعملاء
        </button>
        <div class="user-avatar">c</div>
      </div>
    </div>

    <div class="content-area">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-title">إجمالي الشكاوى</div>
          <div class="stat-value total-complaints" id="totalComplaints">0</div>
          <div class="stat-change up"><i class="fas fa-arrow-up"></i> 12% عن الشهر الماضي</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">شكاوى معلقة</div>
          <div class="stat-value pending-complaints" id="pendingComplaints">0</div>
          <div class="stat-change down"><i class="fas fa-arrow-down"></i> 5% عن الأسبوع الماضي</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">تم حلها</div>
          <div class="stat-value resolved-complaints" id="resolvedComplaints">0</div>
          <div class="stat-change up"><i class="fas fa-arrow-up"></i> 8% عن الأسبوع الماضي</div>
        </div>
        <div class="stat-card">
          <div class="stat-title">مرفوضة</div>
          <div class="stat-value rejected-complaints" id="rejectedComplaints">0</div>
          <div class="stat-change"><i class="fas fa-equals"></i> لا يوجد تغيير</div>
        </div>
      </div>

      <div class="chart-card">
        <h4 class="chart-title">الشكاوى حسب الشهر</h4>
        <canvas id="monthlyChart"></canvas>
      </div>

      <div class="table-container">
        <div class="table-header">
          <h3 class="table-title">آخر الشكاوى</h3>
          <div class="table-filters">
            <select id="complaintFilterStatus">
              <option value="all">جميع الحالات</option>
              <option value="pending">معلقة</option>
              <option value="resolved">تم الحل</option>
              <option value="rejected">مرفوضة</option>
            </select>
            <select id="complaintFilterBranch">
              <option value="all">جميع الفروع</option>
            </select>
            <button id="refreshComplaintsBtn" class="refresh-btn">
              <i class="fas fa-sync-alt"></i> تحديث
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="complaints-table">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>العميل</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="complaintsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal التفاصيل (كما هو) -->
  <div class="details-modal" id="detailsModal"> ... </div>

  <!-- عناصر واجهة المستخدم -->
  <div class="notification-alert" id="notificationAlert">
    <i class="fas fa-bell"></i>
    <span id="notificationText">شكوى جديدة تم تقديمها</span>
  </div>
  <div class="toast" id="toast"></div>
  <button id="installPwaBtn" class="install-pwa-btn hidden">
    <i class="fas fa-download"></i>
  </button>

  <!-- Modal إرسال إشعار جماعي -->
  <div id="broadcastModal">
    <div class="modal-content">
      <h3>إرسال إشعار جماعي للعملاء</h3>
      <input type="text" id="broadcastTitle" placeholder="العنوان (اختياري)" />
      <textarea id="broadcastMessage" placeholder="نص الإشعار (مطلوب)" rows="4"></textarea>
      <input type="url" id="broadcastUrl" placeholder="رابط (اختياري)" />
      <div style="text-align: center; margin-top: 15px;">
        <button id="confirmBroadcast">إرسال</button>
        <button id="cancelBroadcast">إلغاء</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
</body>
</html>

